import java.io.*;
import java.net.*;

public class HiloServidorChat extends Thread {
	DataInputStream fentrada;
	Socket socket = null;
	ComunHilos comun;

	public HiloServidorChat(Socket s, ComunHilos comun) {
		this.socket = s;
		this.comun = comun;
		try {
			// CREO FLUJO DE entrada para leer los mensajes
			fentrada = new DataInputStream(socket.getInputStream());/*para poder recoger los  datos  de los clientes se tiene que hacer un un socket. getInputStream porque el getInputStream recoge los datos que se han introducido  */
		} catch (IOException e) {
			System.out.println("ERROR DE E/S");
			e.printStackTrace();
		}
	}// ..

	public void run() {
		System.out.println("NUMERO DE CONEXIONES ACTUALES: " + comun.getACTUALES());

		// NADA MAS CONECTARSE LE ENVIO TODOS LOS MENSAJES
		String texto = comun.getMensajes();
		EnviarMensajesaTodos(comun, texto);/* aqui e tenido que poner comun, texto porque en la funcion se necesitan tanto el comun, como el texto */

		while (true) {
			String cadena = "";
			try {
				cadena = fentrada.readUTF();
				if (cadena.trim().equals("*")) {// EL CLIENTE SE DESCONECTA
					comun.setACTUALES(comun.getACTUALES() - 1);/* aqui e puesto el comun.getActuales - 1 porque como el cliente se desconecta tenemos que quitar una conexion y para poder hacer eso tenemos que saber la cantidad total de conexiones y restarles 1 */
					System.out.println("NUMERO DE CONEXIONES ACTUALES: " + comun.getACTUALES());
				}

				comun.setUltimo(cadena);
				EnviarMensajesaTodos(comun, cadena);/* aqui e tenido que poner comun, texto porque en la funcion se necesitan tanto el comun, como el texto */

			} catch (Exception e) {// EL CLIENTE SE DESCONECTA A LO BRUTO Ctrl+C o similar
				comun.setACTUALES(comun.getACTUALES()-1);
				System.out.println("NUMERO DE CONEXIONES ACTUALES: " + comun.getACTUALES());
				System.out.println("ERROR: " + e.getMessage());
				break;
			}
		} // fin while

		// se cierra el socket del cliente
		try {
			socket.close();
		} catch (IOException e) {
			e.printStackTrace();
		}

	}// run

	// ENVIA LOS MENSAJES DEL CHAT A LOS CLIENTES
	private void EnviarMensajesaTodos(ComunHilos comun, String texto) {/* aqui ne necesitaban tanto el comun paraa poder sabr las conexiones que hay actualmente y el texto para saber lo que dicen los clientes.  */
		int i;
		// recorremos tabla de sockets para enviarles los mensajes
		for (i = 0; i < comun.getCONEXIONES(); i++) {
			Socket s1 = comun.getElementoTabla(i);
			if (!s1.isClosed()) {
				try {
					DataOutputStream fsalida = new DataOutputStream(s1.getOutputStream());
					fsalida.writeUTF(texto);
				} catch (IOException e) {
					e.printStackTrace();
				}
			}
		} // for

	}// EnviarMensajesaTodos

}// ..HiloServidorChat